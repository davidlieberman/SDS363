---
title: "Problem Set 2"
author: "Liana Wang"
date: "2/7/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(readxl)
library(ggplot2)
library(tidyr)
library("corrplot")
```

##PROBLEM 1 
1). First, discuss whether your data seems to have a multivariate normal distribution. Make univariate plots (boxplots, normal quantile plots as appropriate). Then make transformations as appropriate. You do NOT need to turn all this in, but describe what you did. THEN make a chi-square quantile plot of the data. Turn in your chi-square quantile plot as appropriate and comment on what you see. NOTE that multivariate normality is NOT a requirement for PCA to work!
```{r}
data <- read.csv("https://pastebin.com/raw/z6pgskch")

data <- data %>% drop_na()
data_transformed <- log(data)

QQPlot <- function(x, na.rm = TRUE){
  for (i in names(x)) {
    plots <- ggplot(x, aes_string(sample = i)) +
      stat_qq() + stat_qq_line()
    ggsave(plots, filename = paste(i, ".png", sep=""))
  }

}

QQPlot(data_transformed)



CSQPlot<-function(vars,label="Chi-Square Quantile Plot"){
   #usually, vars is xxx$residuals or data from one group and label is for plot
     x<-cov(scale(vars),use="pairwise.complete.obs")
     squares<-sort(diag(as.matrix(scale(vars))%*%solve(x)%*%as.matrix(t(scale(vars)))))
     quantiles<-quantile(squares)
     hspr<-quantiles[4]-quantiles[2]
     cumprob<-c(1:length(vars[,1]))/length(vars[,1])-1/(2*length(vars[,1]))
     degf<-dim(x)[1]
     quants<-qchisq(cumprob,df=degf)
     gval<-(quants**(-1+degf/2))/(exp(quants/2)*gamma(degf/2)*(sqrt(2)**degf))
     scale<-hspr / (qchisq(.75,degf)-qchisq(.25,degf))
     se<-(scale/gval)*sqrt(cumprob*(1-cumprob)/length(squares))
     lower<-quants-2*se
     upper<-quants+2*se
    plot(quants,squares,col='red',pch=19,cex=1.2,xlab="Chi-Square Quantiles",
     ylab=label,main=paste("Chi-Square Quantiles for",label),ylim=range(upper,lower, squares) , xlim=range(c(0,quants)))
    lines(c(0,100),c(0,100),col=1)
    lines(quants,upper,col="blue",lty=2,lwd=2)
    lines(quants,lower,col="blue",lty=2,lwd=2)
    legend(0,range(upper,lower)[2]*.9,c("Data","95% Conf Limits"),lty=c(0,2),col=c("red","blue"),lwd=c(2,2),
      pch=c(19,NA))
}

CSQPlot(data_transformed,label="Drug Attitudes")

```


##PROBLEM 2 
2). Compute the correlation matrix between all variables (SAS and SPSS will provide this for you as part of the PCA procedure – in SPSS, click on DESCRIPTIVES. In R use the cor() function or one of the other cool correlation plots.). Comment on relationships you do/do not observe. Do you think PCA will work well?
```{r}
#version 1 
corrplot(cor(dta), method = "color")
cor(x)

#version 2 

round(cor(dta), 2)
corrplot.mixed(cor(dta), lower.col="black", upper = "ellipse", tl.col = "black", number.cex=.7, order = "hclust",tl.pos = "lt", tl.cex=.7)
```

##PROBLEM 3 
3). Perform Principle components analysis using the Correlation matrix (standardized variables). Think about how many principle components to retain. To make this decision look at
 Total variance explained by a given number of principle components
 The ‘eigenvalue > 1’ criteria
 The ‘scree plot elbow’ method (turn in the scree plot)
 Parallel Analysis : think about whether this is appropriate based on what you
discover in question 1.
```{r}

data2 <- data[,c(names(data))]
pc1 <- princomp(data2[,-1], cor=TRUE)
print(summary(pc1),digits=2,loadings=pc1$loadings,cutoff=0)
round(pc1$sdev^2,2)

names(pc1)
screeplot(pc1,type="lines",col="red",lwd=2,pch=19,cex=1.2,main="Scree Plot of Raw Drug Data")
source("http://www.reuningscherer.net/STAT660/R/parallel.r.txt")
parallelplot(pc1)

source("http://reuningscherer.net/stat660/r/ciscoreplot.R.txt")
ciscoreplot(pc1,c(1,2),data2[,1])

```


##PROBLEM 4 
4). For principle components you decide to retain, examine the loadings (principle components) and think about an interpretation for each retained component if possible.
```{r}

```


##PROBLEM 5 
5) Make a score plot of the scores for at least one pair of component scores (one and two, one and three, two and three, etc). Discuss any trends/groupings you observe (probably, this will be ‘none’). As a bonus, try to make a 95% Confidence Ellipse for two of your components. You might want to also try making a bi-plot if you’re using R.
```{r}
#make a biplot for first two components
biplot(pc1,choices=c(1,2),pc.biplot=T)
```


##PROBLEM 6 
6). Write a paragraph summarizing your findings, and your opinions about the effectiveness of using principle components on this data. Include evidence based on scatterplots of linearity in higher dimensional space, note any multivariate outliers in your score plot, comment on sample size relative to number of variables, etc.
```{r}

```

